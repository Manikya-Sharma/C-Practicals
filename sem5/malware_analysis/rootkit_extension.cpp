#include <curl/curl.h>
#include <filesystem>
#include <fstream>
#include <iostream>

using namespace std;

bool IS_EXT(string file_name, string ext) {
    int i = file_name.size();
    while (i >= 0) {
        if (file_name[i] == '.') {
            break;
        }
        i--;
    }
    string file_extension = file_name.substr(i, file_name.size()-i+1);
    if (file_extension == ext)
        return true;
    return false;
}

int main() {
    filesystem::path TARGET_FOLDER("./important_folder");

    // post using to libcurl
    CURL* curl;
    CURLcode res;

    string AVOID_EXT = ".pdf";

    string content;

    for (auto file : filesystem::directory_iterator(TARGET_FOLDER)) {
        string file_path = file.path().string();

        if (IS_EXT(file_path, AVOID_EXT)) {
            cout << "SKIPPING" << file_path << endl;
            continue;
        }

        string content;
        ifstream input_stream;
        input_stream.open(file_path);
        while (!input_stream.eof()) {
            char ch = input_stream.get();
            if (ch != EOF) {
                content.push_back(ch);
            }
        }

        input_stream.close();

        // post using to libcurl
        CURL* curl;
        CURLcode res;

        curl = curl_easy_init();
        if (curl) {
            curl_easy_setopt(curl, CURLOPT_URL, "http://localhost:4000");

            curl_easy_setopt(curl, CURLOPT_POSTFIELDS, content.c_str());

            res = curl_easy_perform(curl);

            if (res != CURLE_OK) {
                cout << "Error copying file, please try again" << endl;
            }
            curl_easy_cleanup(curl);
        }
    }
    return 0;
}
